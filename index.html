<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Kategori Dropdown Interaktif dengan Cari</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #000; padding: 5px; text-align: left; }
  th { background-color: #f2f2f2; }
  tr:hover { background-color: #f9f9f9; cursor: pointer; }
  .selected { background-color: #d0ebff !important; }
</style>
</head>
<body>

<h2>Filter Mengikut Kategori</h2>
<input type="text" id="kategoriSearch" placeholder="Cari kategori (Column G)">
<br><br>

<h3>Ringkasan Column E</h3>
<table id="kategoriTable">
  <thead>
    <tr>
      <th>Column E</th>
      <th>Jumlah Column D</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Detail Data</h3>
<table id="detailTable">
  <thead>
    <tr>
      <th>Column A</th>
      <th>Column B</th>
      <th>Column C</th>
      <th>Column D</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p><strong>Jumlah Column D:</strong> <span id="detailSumD">0</span></p>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKxmTXERKgk9gTUlqlyeRrmdfJU21FMdj1mDpf5azCa_hW4Gfg5TgpQcHvb-ujRo72cLIN2p0Lkgcj/pub?output=csv&gid=975658514';
let sheetData = [];
let selectedRow = null;

// Parse CSV dengan PapaParse
Papa.parse(sheetURL, {
  download: true,
  header: false,
  skipEmptyLines: true,
  complete: function(results) {
    sheetData = results.data;
    displayKategori(''); // Papar semua awalnya
  }
});

// Event search box
document.getElementById('kategoriSearch').addEventListener('input', function() {
  const searchValue = this.value.trim().toUpperCase();
  displayKategori(searchValue);
});

// Function paparkan ringkasan kategori
function displayKategori(searchValue){
  const tbody = document.querySelector('#kategoriTable tbody');
  tbody.innerHTML = '';
  document.querySelector('#detailTable tbody').innerHTML = '';
  document.getElementById('detailSumD').textContent = '0';
  selectedRow = null;

  // Filter berdasarkan Column G (index 6)
  let filtered = sheetData;
  if(searchValue){
    filtered = sheetData.filter(r => (r[6] || '').toUpperCase().includes(searchValue));
  }

  // Group by Column E (index 4)
  const groupMap = {};
  filtered.forEach(r => {
    const key = r[4];
    const val = parseFloat(r[3] || 0);
    if(groupMap[key]) groupMap[key] += val;
    else groupMap[key] = val;
  });

  // Sort menurun ikut jumlah D
  const sorted = Object.entries(groupMap).sort((a,b) => b[1]-a[1]);

  sorted.forEach(([colE, sumD]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${colE}</td><td>${sumD}</td>`;
    tr.addEventListener('click', () => {
      if(selectedRow) selectedRow.classList.remove('selected');
      tr.classList.add('selected');
      selectedRow = tr;
      showDetail(colE);
    });
    tbody.appendChild(tr);
  });
}

// Function paparkan detail Column A-D untuk Column E terpilih
function showDetail(colEValue){
  const detailRows = sheetData.filter(r => r[4] === colEValue);
  const tbody = document.querySelector('#detailTable tbody');
  tbody.innerHTML = '';

  // Sort detail ikut Column D menurun
  const sortedRows = detailRows.sort((a,b) => parseFloat(b[3]||0) - parseFloat(a[3]||0));

  let sumD = 0;
  sortedRows.forEach(r => {
    const tr = document.createElement('tr');
    [0,1,2,3].forEach(i => {
      const td = document.createElement('td');
      td.textContent = r[i];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
    sumD += parseFloat(r[3]||0);
  });
  document.getElementById('detailSumD').textContent = sumD;
}
</script>
</body>
</html>
