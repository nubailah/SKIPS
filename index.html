<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paparan Data Google Sheets</title>
</head>
<body>
  <h2>Filter Mengikut Kategori</h2>
  <select id="kategoriDropdown">
    <option value="">-- Pilih Kategori --</option>
    <option value="Pentadbiran">Pentadbiran</option>
    <option value="Perakaunan">Perakaunan</option>
    <option value="Sains Kuantitatif">Sains Kuantitatif</option>
    <option value="Bahasa Inggeris">Bahasa Inggeris</option>
    <option value="Pengajian Am">Pengajian Am</option>
  </select>

  <div id="kategoriResult"></div>

  <hr>

  <h2>Carian Staf (Column G)</h2>
  <select id="stafDropdown">
    <option value="">-- Pilih Staf --</option>
  </select>

  <table border="1">
    <thead>
      <tr>
        <th>Column A</th>
        <th>Column B</th>
        <th>Column C</th>
        <th>Column D</th>
      </tr>
    </thead>
    <tbody id="stafTableBody"></tbody>
  </table>
  <p><strong>Jumlah Column D:</strong> <span id="stafSumD">0</span></p>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKxmTXERKgk9gTUlqlyeRrmdfJU21FMdj1mDpf5azCa_hW4Gfg5TgpQcHvb-ujRo72cLIN2p0Lkgcj/pub?output=csv&gid=975658514';
    let sheetData = [];

    // Mapping kategori â†’ suffix Column E
    const kategoriMap = {
      "Pentadbiran": "PT",
      "Perakaunan": "ACC",
      "Sains Kuantitatif": "QS",
      "Bahasa Inggeris": "ENG",
      "Pengajian Am": "PAM"
    };

    fetch(sheetURL)
      .then(res => res.text())
      .then(data => {
        // Parse CSV, remove empty rows
        sheetData = data.split('\n').map(r => r.split(',')).filter(r => r.length > 1);

        // Populate staf dropdown (unique Column G)
        const stafDropdown = document.getElementById('stafDropdown');
        const uniqueStaf = [...new Set(sheetData.map(r => r[6]))];
        uniqueStaf.forEach(staf => {
          const option = document.createElement('option');
          option.value = staf;
          option.textContent = staf;
          stafDropdown.appendChild(option);
        });
      });

    // Event kategori dropdown
    document.getElementById('kategoriDropdown').addEventListener('change', function() {
      const selected = this.value;
      const suffix = kategoriMap[selected];
      if (!suffix) return;

      const filtered = sheetData.filter(r => r[4] && r[4].endsWith(suffix));

      // Group by Column E and sum Column D
      const groupMap = {};
      filtered.forEach(r => {
        const key = r[4];
        const val = parseFloat(r[3] || 0);
        if (groupMap[key]) groupMap[key] += val;
        else groupMap[key] = val;
      });

      // Display
      const resultDiv = document.getElementById('kategoriResult');
      if(Object.keys(groupMap).length === 0){
        resultDiv.innerHTML = '<p>Tiada data untuk kategori ini.</p>';
      } else {
        resultDiv.innerHTML = '<ul>' +
          Object.entries(groupMap).map(([k, v]) => `<li>${k}: ${v}</li>`).join('') +
          '</ul>';
      }
    });

    // Event staf dropdown
    document.getElementById('stafDropdown').addEventListener('change', function() {
      const selected = this.value;
      const filtered = sheetData.filter(r => r[6] === selected);

      const tbody = document.getElementById('stafTableBody');
      tbody.innerHTML = '';
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        [0,1,2,3].forEach(i => {
          const td = document.createElement('td');
          td.textContent = r[i];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // Sum Column D group by Column G (for selected staff)
      const sumD = filtered.reduce((acc, r) => acc + parseFloat(r[3] || 0), 0);
      document.getElementById('stafSumD').textContent = sumD;
    });
  </script>
</body>
</html>
