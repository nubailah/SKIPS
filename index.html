<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Gabungan Kategori & Carian Jawatankuasa</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f8f9fa;
  }
  h2 {
    color: #333;
  }
  select {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 5px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
  }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-bottom: 20px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  th, td { 
    border: 1px solid #ddd; 
    padding: 10px; 
    text-align: left;
  }
  th { 
    background-color: #007BFF; 
    color: white;
    font-weight: bold;
  }
  tr:hover { 
    background-color: #e9f5ff; 
    cursor: pointer;
  }
  .selected { 
    background-color: #cce5ff !important; 
  }
  p { font-size: 16px; font-weight: bold; }
  hr { border: 1px solid #ccc; margin: 40px 0; }
</style>
</head>
<body>

<h2>Filter Mengikut Kategori</h2>
<select id="kategoriDropdown">
  <option value="">-- Pilih Kategori --</option>
  <option value="PT">Pentadbiran</option>
  <option value="ACC">Perakaunan</option>
  <option value="QS">Sains Kuantitatif</option>
  <option value="ENG">Bahasa Inggeris</option>
  <option value="PAM">Pengajian Am</option>
</select>

<h3>Ringkasan Column E</h3>
<table id="kategoriTable">
  <thead>
    <tr>
      <th>Column E</th>
      <th>Jumlah Column D</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Detail Data Kategori</h3>
<table id="detailTable">
  <thead>
    <tr>
      <th>Column A</th>
      <th>Column B</th>
      <th>Column C</th>
      <th>Column D</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p><strong>Jumlah Column D:</strong> <span id="detailSumD">0</span></p>

<hr>

<h2>Carian Jawatankuasa (Column B)</h2>
<select id="jawatankuasaDropdown">
  <option value="">-- Pilih Jawatankuasa --</option>
</select>
<table id="jawatankuasaTable">
  <thead>
    <tr>
      <th>Column A</th>
      <th>Column D</th>
      <th>Column F</th>
    </tr>
  </thead>
  <tbody id="jawatankuasaTableBody"></tbody>
</table>
<p><strong>Jumlah Column D:</strong> <span id="jawatankuasaSumD">0</span></p>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKxmTXERKgk9gTUlqlyeRrmdfJU21FMdj1mDpf5azCa_hW4Gfg5TgpQcHvb-ujRo72cLIN2p0Lkgcj/pub?output=csv&gid=975658514';
let sheetData = [];
let selectedRowKategori = null;

// Mapping dropdown value ke suffix
const kategoriMap = { "PT": "PT", "ACC": "ACC", "QS": "QS", "ENG": "ENG", "PAM": "PAM" };

// Fetch CSV & parse
Papa.parse(sheetURL, {
  download: true,
  header: false,
  skipEmptyLines: true,
  complete: function(results) {
    sheetData = results.data;
    populateJawatankuasaDropdown();
  }
});

// ====== KATEGORI SECTION ======
document.getElementById('kategoriDropdown').addEventListener('change', function() {
  const suffix = this.value;
  const tbody = document.querySelector('#kategoriTable tbody');
  tbody.innerHTML = '';
  document.querySelector('#detailTable tbody').innerHTML = '';
  document.getElementById('detailSumD').textContent = '0';
  selectedRowKategori = null;

  if(!suffix) return;

  const filtered = sheetData.filter(r => r[4] && r[4].endsWith(suffix));

  // Group by Column E
  const groupMap = {};
  filtered.forEach(r => {
    const key = r[4];
    const val = parseFloat(r[3] || 0);
    if(groupMap[key]) groupMap[key] += val;
    else groupMap[key] = val;
  });

  const sorted = Object.entries(groupMap).sort((a,b) => b[1]-a[1]);

  sorted.forEach(([colE, sumD]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${colE}</td><td>${sumD}</td>`;
    tr.addEventListener('click', () => {
      if(selectedRowKategori) selectedRowKategori.classList.remove('selected');
      tr.classList.add('selected');
      selectedRowKategori = tr;
      showDetailKategori(colE);
    });
    tbody.appendChild(tr);
  });
});

function showDetailKategori(colEValue){
  const detailRows = sheetData.filter(r => r[4] === colEValue);
  const tbody = document.querySelector('#detailTable tbody');
  tbody.innerHTML = '';

  const sortedRows = detailRows.sort((a,b) => parseFloat(b[3]||0) - parseFloat(a[3]||0));

  let sumD = 0;
  sortedRows.forEach(r => {
    const tr = document.createElement('tr');
    [0,1,2,3].forEach(i => {
      const td = document.createElement('td');
      td.textContent = r[i];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
    sumD += parseFloat(r[3]||0);
  });
  document.getElementById('detailSumD').textContent = sumD;
}

// ====== JAWATANKUASA SECTION ======
function populateJawatankuasaDropdown(){
  const dropdown = document.getElementById('jawatankuasaDropdown');
  const uniqueValues = [...new Set(sheetData.map(r => r[1].trim()))];
  uniqueValues.forEach(val => {
    const option = document.createElement('option');
    option.value = val;
    option.textContent = val;
    dropdown.appendChild(option);
  });
}

document.getElementById('jawatankuasaDropdown').addEventListener('change', function() {
  const selected = this.value;
  const filtered = sheetData.filter(r => r[1].trim() === selected);
  const tbody = document.getElementById('jawatankuasaTableBody');
  tbody.innerHTML = '';

  filtered.forEach(r => {
    const tr = document.createElement('tr');
    [0,3,5].forEach(i => { // Column A, D, F
      const td = document.createElement('td');
      td.textContent = r[i];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  const sumD = filtered.reduce((acc,r) => acc + parseFloat(r[3] || 0), 0);
  document.getElementById('jawatankuasaSumD').textContent = sumD;
});
</script>
</body>
</html>
