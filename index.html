<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paparan Data Google Sheets</title>
  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #000; padding: 5px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Filter Mengikut Kategori</h2>
  <select id="kategoriDropdown">
    <option value="">-- Pilih Kategori --</option>
    <option value="Pentadbiran">Pentadbiran</option>
    <option value="Perakaunan">Perakaunan</option>
    <option value="Sains Kuantitatif">Sains Kuantitatif</option>
    <option value="Bahasa Inggeris">Bahasa Inggeris</option>
    <option value="Pengajian Am">Pengajian Am</option>
  </select>

  <table id="kategoriTable">
    <thead>
      <tr>
        <th>Column E</th>
        <th>Jumlah Column D</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr>

  <h2>Carian Staf (Column F)</h2>
  <select id="stafDropdown">
    <option value="">-- Pilih Staf --</option>
  </select>

  <table id="stafTable">
    <thead>
      <tr>
        <th>Column A</th>
        <th>Column B</th>
        <th>Column C</th>
        <th>Column D</th>
      </tr>
    </thead>
    <tbody id="stafTableBody"></tbody>
  </table>
  <p><strong>Jumlah Column D:</strong> <span id="stafSumD">0</span></p>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKxmTXERKgk9gTUlqlyeRrmdfJU21FMdj1mDpf5azCa_hW4Gfg5TgpQcHvb-ujRo72cLIN2p0Lkgcj/pub?output=csv&gid=975658514';
    let sheetData = [];

    const kategoriMap = {
      "Pentadbiran": "PT",
      "Perakaunan": "ACC",
      "Sains Kuantitatif": "QS",
      "Bahasa Inggeris": "ENG",
      "Pengajian Am": "PAM"
    };

    fetch(sheetURL)
      .then(res => res.text())
      .then(data => {
        sheetData = data.split('\n').map(r => r.split(',')).filter(r => r.length > 1);

        // Populate staf dropdown (Column F)
        const stafDropdown = document.getElementById('stafDropdown');
        const uniqueStaf = [...new Set(sheetData.map(r => r[5]))];
        uniqueStaf.forEach(staf => {
          const option = document.createElement('option');
          option.value = staf;
          option.textContent = staf;
          stafDropdown.appendChild(option);
        });
      });

    // Kategori dropdown
    document.getElementById('kategoriDropdown').addEventListener('change', function() {
      const selected = this.value;
      const suffix = kategoriMap[selected];
      const tbody = document.querySelector('#kategoriTable tbody');
      tbody.innerHTML = '';

      if(!suffix) return;

      const filtered = sheetData.filter(r => r[4] && r[4].endsWith(suffix));

      // Group by Column E
      const groupMap = {};
      filtered.forEach(r => {
        const key = r[4];
        const val = parseFloat(r[3] || 0);
        if(groupMap[key]) groupMap[key] += val;
        else groupMap[key] = val;
      });

      // Sort menurun ikut jumlah D
      const sorted = Object.entries(groupMap).sort((a,b) => b[1] - a[1]);

      sorted.forEach(([colE, sumD]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${colE}</td><td>${sumD}</td>`;
        tbody.appendChild(tr);
      });
    });

    // Staf dropdown
    document.getElementById('stafDropdown').addEventListener('change', function() {
      const selected = this.value;
      const filtered = sheetData.filter(r => r[5] === selected);

      const tbody = document.getElementById('stafTableBody');
      tbody.innerHTML = '';

      filtered.forEach(r => {
        const tr = document.createElement('tr');
        [0,1,2,3].forEach(i => {
          const td = document.createElement('td');
          td.textContent = r[i];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      const sumD = filtered.reduce((acc,r) => acc + parseFloat(r[3] || 0), 0);
      document.getElementById('stafSumD').textContent = sumD;
    });
  </script>
</body>
</html>
