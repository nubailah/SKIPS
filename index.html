<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Gabungan Kategori & Carian Jawatankuasa (Real-Time)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
  h2 { color: #333; }
  select { padding: 8px 12px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
  th { background-color: #007BFF; color: white; font-weight: bold; }
  tr:hover { background-color: #e9f5ff; cursor: pointer; }
  .selected { background-color: #cce5ff !important; }
  p { font-size: 16px; font-weight: bold; }
  hr { border: 1px solid #ccc; margin: 40px 0; }
</style>
</head>
<body>

<h2>Filter Mengikut Kategori</h2>
<select id="kategoriDropdown">
  <option value="">-- Pilih Kategori --</option>
  <option value="PT">Pentadbiran</option>
  <option value="ACC">Perakaunan</option>
  <option value="QS">Sains Kuantitatif</option>
  <option value="ENG">Bahasa Inggeris</option>
  <option value="PAM">Pengajian Am</option>
</select>

<h3>Ringkasan</h3>
<table id="kategoriTable">
  <thead>
    <tr><th>NAMA STAFF</th><th>JUMLAH PEMBERAT</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Detail Kategori</h3>
<table id="detailTable">
  <thead>
    <tr><th>KOD</th><th>JAWATANKUASA</th><th>JAWATAN</th><th>PEMBERAT</th></tr>
  </thead>
  <tbody></tbody>
</table>
<p><strong>JUMLAH PEMBERAT:</strong> <span id="detailSumD">0</span></p>

<hr>

<h2>Carian Jawatankuasa</h2>
<select id="jawatankuasaDropdown">
  <option value="">-- Pilih Jawatankuasa --</option>
</select>
<table id="jawatankuasaTable">
  <thead>
    <tr><th>JAWATAN (Column C)</th><th>PEMBERAT (Column D)</th><th>NAMA STAFF (Column F)</th></tr>
  </thead>
  <tbody id="jawatankuasaTableBody"></tbody>
</table>
<p><strong>BILANGAN NAMA STAFF:</strong> <span id="jawatankuasaCount">0</span></p>

<script>
const jsonURL = "https://script.google.com/macros/s/AKfycbzvfPYyyabKE0_gnAtfJO_f5HKxE2YB2q8a7s_cl-1eRIPt3EJFt4MI1ICGDublE8FNLA/exec"; // Gantikan dengan URL Apps Script Web App
let sheetData = [];
let selectedRowKategori = null;

// ====== FETCH DATA REAL-TIME ======
function fetchSheetJSON() {
  fetch(jsonURL)
    .then(res => res.json())
    .then(data => {
      sheetData = data;
      populateJawatankuasaDropdown();
      const kategoriDropdown = document.getElementById("kategoriDropdown");
      if(kategoriDropdown.value) kategoriDropdown.dispatchEvent(new Event("change"));
      const jawatankuasaDropdown = document.getElementById("jawatankuasaDropdown");
      if(jawatankuasaDropdown.value) jawatankuasaDropdown.dispatchEvent(new Event("change"));
    })
    .catch(err => console.error("Fetch error:", err));
}

// Initial fetch & polling setiap 5 saat
fetchSheetJSON();
setInterval(fetchSheetJSON, 5000);

// ====== KATEGORI ======
document.getElementById('kategoriDropdown').addEventListener('change', function() {
  const suffix = this.value;
  const tbody = document.querySelector('#kategoriTable tbody');
  tbody.innerHTML = '';
  document.querySelector('#detailTable tbody').innerHTML = '';
  document.getElementById('detailSumD').textContent = '0';
  selectedRowKategori = null;
  if(!suffix) return;

  const filtered = sheetData.filter(r => r.E && r.E.endsWith(suffix));

  // Group by NAMA STAFF (Column E)
  const groupMap = {};
  filtered.forEach(r => {
    const key = r.E;
    const val = parseFloat(r.D || 0);
    groupMap[key] = (groupMap[key] || 0) + val;
  });

  const sorted = Object.entries(groupMap).sort((a,b) => b[1]-a[1]);

  sorted.forEach(([name,sum]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${sum}</td>`;
    tr.addEventListener('click', () => {
      if(selectedRowKategori) selectedRowKategori.classList.remove('selected');
      tr.classList.add('selected');
      selectedRowKategori = tr;
      showDetailKategori(name);
    });
    tbody.appendChild(tr);
  });
});

function showDetailKategori(name){
  const detailRows = sheetData.filter(r => r.E === name);
  const tbody = document.querySelector('#detailTable tbody');
  tbody.innerHTML = '';
  const sortedRows = detailRows.sort((a,b) => parseFloat(b.D||0)-parseFloat(a.D||0));
  let sumD = 0;
  sortedRows.forEach(r => {
    const tr = document.createElement('tr');
    ['A','B','C','D'].forEach(col => {
      const td = document.createElement('td');
      td.textContent = r[col];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
    sumD += parseFloat(r.D||0);
  });
  document.getElementById('detailSumD').textContent = sumD;
}

// ====== JAWATANKUASA ======
function populateJawatankuasaDropdown(){
  const dropdown = document.getElementById('jawatankuasaDropdown');
  const uniqueValues = [...new Set(sheetData.map(r => r.B.trim()))];
  dropdown.innerHTML = '<option value="">-- Pilih Jawatankuasa --</option>';
  uniqueValues.forEach(val => {
    const option = document.createElement('option');
    option.value = val;
    option.textContent = val;
    dropdown.appendChild(option);
  });
}

document.getElementById('jawatankuasaDropdown').addEventListener('change', function() {
  const selected = this.value;
  const filtered = sheetData.filter(r => r.B.trim() === selected);
  const tbody = document.getElementById('jawatankuasaTableBody');
  tbody.innerHTML = '';

  filtered.forEach(r => {
    const tr = document.createElement('tr');
    ['C','D','F'].forEach(col => {
      const td = document.createElement('td');
      td.textContent = r[col];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  const uniqueF = new Set(filtered.map(r => r.F.trim()));
  document.getElementById('jawatankuasaCount').textContent = uniqueF.size;
});
</script>
</body>
</html>
