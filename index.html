<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Gabungan Kategori & Carian Jawatankuasa</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f8f9fa;
  }
  h2 {
    color: #333;
  }
  select {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 5px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
  }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-bottom: 20px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  th, td { 
    border: 1px solid #ddd; 
    padding: 10px; 
    text-align: left;
  }
  th { 
    background-color: #007BFF; 
    color: white;
    font-weight: bold;
  }
  tr:hover { 
    background-color: #e9f5ff; 
    cursor: pointer;
  }
  .selected { 
    background-color: #cce5ff !important; 
  }
  p { font-size: 16px; font-weight: bold; }
  hr { border: 1px solid #ccc; margin: 40px 0; }
</style>
</head>
<body>

<h2>Filter Mengikut Kategori</h2>
<select id="kategoriDropdown">
  <option value="">-- Pilih Kategori --</option>
  <option value="PT">Pentadbiran</option>
  <option value="ACC">Perakaunan</option>
  <option value="QS">Sains Kuantitatif</option>
  <option value="ENG">Bahasa Inggeris</option>
  <option value="PAM">Pengajian Am</option>
</select>

<h3>Ringkasan</h3>
<table id="kategoriTable">
  <thead>
    <tr>
      <th>NAMA STAFF</th>
      <th>JUMLAH PEMBERAT</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Detail Kategori</h3>
<table id="detailTable">
  <thead>
    <tr>
      <th>KOD</th>
      <th>JAWATANKUASA</th>
      <th>JAWATAN</th>
      <th>PEMBERAT</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p><strong>JUMLAH PEMBERAT:</strong> <span id="detailSumD">0</span></p>

<hr>

<h2>Carian Jawatankuasa</h2>
<select id="jawatankuasaDropdown">
  <option value="">-- Pilih Jawatankuasa --</option>
</select>
<table id="jawatankuasaTable">
  <thead>
    <tr>
      <th>JAWATAN (Column C)</th>
      <th>PEMBERAT (Column D)</th>
      <th>NAMA STAFF (Column F)</th>
    </tr>
  </thead>
  <tbody id="jawatankuasaTableBody"></tbody>
</table>
<p><strong>BILANGAN NAMA STAFF:</strong> <span id="jawatankuasaCount">0</span></p>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKxmTXERKgk9gTUlqlyeRrmdfJU21FMdj1mDpf5azCa_hW4Gfg5TgpQcHvb-ujRo72cLIN2p0Lkgcj/pub?output=csv&gid=975658514';
let sheetData = [];
let selectedRowKategori = null;

// ====== FETCH DATA FUNCTION ======
function fetchSheetData() {
  Papa.parse(sheetURL, {
    download: true,
    header: false,
    skipEmptyLines: true,
    complete: function(results) {
      sheetData = results.data;
      populateJawatankuasaDropdown(); // Update dropdown

      // Refresh kategori table jika ada pilihan
      const kategoriDropdown = document.getElementById('kategoriDropdown');
      if(kategoriDropdown.value) {
        kategoriDropdown.dispatchEvent(new Event('change'));
      }

      // Refresh jawatankuasa table jika ada pilihan
      const jawatankuasaDropdown = document.getElementById('jawatankuasaDropdown');
      if(jawatankuasaDropdown.value) {
        jawatankuasaDropdown.dispatchEvent(new Event('change'));
      }
    }
  });
}

// Panggil fetch semasa load
fetchSheetData();

// Auto-refresh setiap 30 saat
setInterval(fetchSheetData, 30000);

// ====== KATEGORI SECTION ======
document.getElementById('kategoriDropdown').addEventListener('change', function() {
  const suffix = this.value;
  const tbody = document.querySelector('#kategoriTable tbody');
  tbody.innerHTML = '';
  document.querySelector('#detailTable tbody').innerHTML = '';
  document.getElementById('detailSumD').textContent = '0';
  selectedRowKategori = null;

  if(!suffix) return;

  const filtered = sheetData.filter(r => r[4] && r[4].endsWith(suffix));

  // Group by NAMA STAFF (Column E)
  const groupMap = {};
  filtered.forEach(r => {
    const key = r[4]; // Column E
    const val = parseFloat(r[3] || 0); // Column D
    if(groupMap[key]) groupMap[key] += val;
    else groupMap[key] = val;
  });

  const sorted = Object.entries(groupMap).sort((a,b) => b[1]-a[1]);

  sorted.forEach(([name, sum]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${sum}</td>`;
    tr.addEventListener('click', () => {
      if(selectedRowKategori) selectedRowKategori.classList.remove('selected');
      tr.classList.add('selected');
      selectedRowKategori = tr;
      showDetailKategori(name);
    });
    tbody.appendChild(tr);
  });
});

function showDetailKategori(name){
  const detailRows = sheetData.filter(r => r[4] === name);
  const tbody = document.querySelector('#detailTable tbody');
  tbody.innerHTML = '';

  const sortedRows = detailRows.sort((a,b) => parseFloat(b[3]||0) - parseFloat(a[3]||0));

  let sumD = 0;
  sortedRows.forEach(r => {
    const tr = document.createElement('tr');
    [0,1,2,3].forEach(i => { // Column A-D
      const td = document.createElement('td');
      td.textContent = r[i];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
    sumD += parseFloat(r[3]||0);
  });
  document.getElementById('detailSumD').textContent = sumD;
}

// ====== JAWATANKUASA SECTION ======
function populateJawatankuasaDropdown(){
  const dropdown = document.getElementById('jawatankuasaDropdown');
  const uniqueValues = [...new Set(sheetData.map(r => r[1].trim()))]; // Column B
  dropdown.innerHTML = '<option value="">-- Pilih Jawatankuasa --</option>'; // Reset options
  uniqueValues.forEach(val => {
    const option = document.createElement('option');
    option.value = val;
    option.textContent = val;
    dropdown.appendChild(option);
  });
}

document.getElementById('jawatankuasaDropdown').addEventListener('change', function() {
  const selected = this.value;
  const filtered = sheetData.filter(r => r[1].trim() === selected); // Column B
  const tbody = document.getElementById('jawatankuasaTableBody');
  tbody.innerHTML = '';

  filtered.forEach(r => {
    const tr = document.createElement('tr');
    [2,3,5].forEach(i => { // Column C, D, F
      const td = document.createElement('td');
      td.textContent = r[i];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Bilangan unik NAMA STAFF (Column F)
  const uniqueF = new Set(filtered.map(r => r[5].trim()));
  document.getElementById('jawatankuasaCount').textContent = uniqueF.size;
});
</script>
</body>
</html>
